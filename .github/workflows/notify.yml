name: CI Failure Notifications

on:
  workflow_run:
    workflows:
      - "Style Checks"
      - "Static Analysis"
      - "PHPUnit Tests"
    types: [completed]

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack alert
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": ":rotating_light: Workflow `${{ github.event.workflow.name }}` failed (status: `${{ github.event.workflow_run.conclusion }}`) on branch `${{ github.event.workflow_run.head_branch }}` at `${{ github.event.workflow_run.updated_at }}`. See run: ${{ github.event.workflow_run.html_url }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "CI Failed â€” ${{ github.event.workflow.name }} on ${{ github.event.workflow_run.head_branch }}"
          to: ${{ secrets.ALERT_EMAIL }}
          from: "CI Bot <ci@example.com>"
          body: |
            Workflow: ${{ github.event.workflow.name }}
            Status: ${{ github.event.workflow_run.conclusion }}
            Branch: ${{ github.event.workflow_run.head_branch }}
            Updated At: ${{ github.event.workflow_run.updated_at }}
            URL: ${{ github.event.workflow_run.html_url }}

    # Reminder: deploy.yml can listen to successful Tests workflow without touching this file.
